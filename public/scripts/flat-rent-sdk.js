const database = [
  {
    id: 'vnd331',
    title: 'Radisson Royal Hotel',
    details: 'Отель расположен в 4 минутах ходьбы от станции метро «Маяковская». К услугам гостей фитнес-центр и спа-центр с сауной и гидромассажной ванной.',
    photos: ['vnd331.png', 'vnd331.png'],
    coordinates: [59.9322936, 30.3460129],
    bookedDates: [],
    price: 12000
  },
  {
    id: 'ab2e2',
    title: 'Номера на Садовой',
    details: 'Расположен в 7 минутах ходьбы от Невского проспекта. К услугам гостей круглосуточная стойка регистрации и бесплатный Wi-Fi.',
    photos: ['ab2e2.png', 'ab2e2.png'],
    coordinates: [59.930325, 30.3291592],
    bookedDates: [],
    price: 4500
  },
  {
    id: 'mvm32l',
    title: 'Мини Отель на Невском 136',
    details: 'Мини-отель расположен в Санкт-Петербурге, в 5 минутах ходьбы от станции метро «Площадь Восстания» и Московского железнодорожного вокзала.',
    photos: ['mvm32l.png', 'mvm32l.png'],
    coordinates: [59.9299603, 30.3658932],
    bookedDates: [],
    price: 3800
  },
  {
    id: 'bvep12',
    title: 'Отель Усадьба Державина',
    details: 'Прекрасный отель недалеко от Исаакиевского собора с бесплатным Wi-Fi на всей территории.',
    photos: ['bvep12.png', 'bvep12.png'],
    coordinates: [59.9194966, 30.309389],
    bookedDates: [],
    price: 8700
  }
];
export function cloneDate(date) {
  return new Date(date.getTime());
}
export function addDays(date, days) {
  date.setDate(date.getDate() + days);
  return date;
}
export const backendPort = 3040;
export const localStorageKey = 'flat-rent-db';
export class FlatRentSdk {
  constructor() {
    this._generateTransactionId = () => {
      const min = 1000;
      const max = 9999;
      const num = Math.random() * (max - min) + min;
      return Math.floor(num);
    };
    if (this._readDatabase() == null) {
      this._writeDatabase(database);
    }
    this.database = this._readDatabase();
  }
  /**
     * Get flat by ID.
     *
     * @param {string} id Flat ID.
     * @returns {Promise<Object|null>} Flat.
     */
  get(id) {
    const flat = this.database.find((item) => {
      return item.id === id;
    });
    return Promise.resolve(flat == null ? flat : this._formatFlatObject(flat));
  }
  /**
     * Search for flats.
     *
     * @param {Object} parameters Search parameters
     * @param {string}parameters.city City name
     * @param {Date} parameters.checkInDate Check-in date
     * @param {Date} parameters.checkOutDate Check-out date
     * @param {number} [parameters.priceLimit] Max price for a night
     * @returns {Object[]} List of suitable flats.
     */
  search(parameters) {
    return new Promise((resolve, reject) => {
      try {
        if (parameters.city != 'Санкт-Петербург') {
          throw new Error(`Passed unsupported city - "${parameters.city}".`);
        }
        if (!(parameters.checkInDate instanceof Date) || !(parameters.checkOutDate instanceof Date)) {
          throw new Error(`Passed invalid check-in or check-out date - from "${parameters.checkInDate}" to "${parameters.checkOutDate}".`);
        }
        this._assertDatesAreCorrect(parameters.checkInDate, parameters.checkOutDate);
        if (parameters.priceLimit != null && (isNaN(parameters.priceLimit) || !isFinite(parameters.priceLimit))) {
          throw new Error(`Passed invalid price limit - "${parameters.priceLimit}".`);
        }
        let flats = this.database;
        if (parameters.priceLimit != null) {
          flats = flats.filter((flat) => {
            return flat.price <= parameters.priceLimit;
          });
        }
        const dateRange = this._generateDateRange(parameters.checkInDate, parameters.checkOutDate);
        flats = flats.filter((flat) => {
          return this._areAllDatesAvailable(flat, dateRange);
        });
        flats = flats.map((flat) => {
          return this._formatFlatObject(flat, dateRange.length - 1);
        });
        resolve(flats);
      }
      catch (error) {
        reject(error);
      }
    });
  }
  /**
     * Book flat.
     *
     * @param {number} flatId
     * @param {Date} checkInDate
     * @param {Date} checkOutDate
     * @returns {number}
     */
  book(flatId, checkInDate, checkOutDate) {
    return new Promise((resolve, reject) => {
      try {
        const flat = this.database.find((item) => {
          return item.id === flatId;
        });
        if (flat == null) {
          throw new Error('There is no flat with ID "' + flatId + '".');
        }
        this._assertDatesAreCorrect(checkInDate, checkOutDate);
        const datesToBook = this._generateDateRange(checkInDate, checkOutDate);
        if (!this._areAllDatesAvailable(flat, datesToBook)) {
          throw new Error(`Flat ${flat.id} is not available for dates ${datesToBook.join(',')}.`);
        }
        const bookedDates = datesToBook.map((date) => {
          return date.getTime();
        });
        flat.bookedDates.push(...bookedDates);
        for (let i = 0; i < this.database.length; i++) {
          if (this.database[i].id === flat.id) {
            this.database[i] = flat;
            break;
          }
        }
        this._writeDatabase(this.database);
        resolve(this._generateTransactionId());
      }
      catch (error) {
        reject(error);
      }
    });
  }
  _assertDatesAreCorrect(checkInDate, checkOutDate) {
    const today = new Date();
    this._resetTime(today);
    this._resetTime(checkInDate);
    this._resetTime(checkOutDate);
    const diffToday = this._calculateDifferenceInDays(today, checkInDate);
    if (diffToday < 0) {
      throw new Error('Check-in date can\'t be in the past.');
    }
    const diffCheck = this._calculateDifferenceInDays(checkInDate, checkOutDate);
    if (diffCheck < 0) {
      throw new Error('Check-out date must be grater then check-in date.');
    }
  }
  _resetTime(date) {
    date.setHours(0);
    date.setMinutes(0);
    date.setSeconds(0);
    date.setMilliseconds(0);
  }
  _calculateDifferenceInDays(startDate, endDate) {
    const difference = endDate.getTime() - startDate.getTime();
    return Math.floor(difference / (1000 * 60 * 60 * 24));
  }
  _generateDateRange(from, to) {
    const dates = [];
    const differenceInDays = this._calculateDifferenceInDays(from, to);
    dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate()));
    for (let i = 1; i <= differenceInDays; i++) {
      dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate() + i));
    }
    return dates;
  }
  _areAllDatesAvailable(flat, dateRange) {
    return dateRange.every((date) => {
      return !flat.bookedDates.includes(date.getTime());
    });
  }
  _formatFlatObject(flat, nightNumber) {
    const formattedFlat = Object.assign({}, flat);
    formattedFlat.photos = formattedFlat.photos.map((photoUrl) => {
      return `http://localhost:${backendPort}/img/${photoUrl}`;
    });
    if (nightNumber != null) {
      formattedFlat.totalPrice = nightNumber * formattedFlat.price;
      delete formattedFlat.price;
    }
    return formattedFlat;
  }
  _readDatabase() {
    const data = window.localStorage.getItem(localStorageKey);
    if (data == null) {
      return data;
    }
    return JSON.parse(data);
  }
  _writeDatabase(database) {
    window.localStorage.setItem(localStorageKey, JSON.stringify(database));
  }
  _syncDatabase(database) {
    this._writeDatabase(database);
    this.database = this._readDatabase();
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhdC1yZW50LXNkay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mbGF0LXJlbnQtc2RrLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE1BQU0sUUFBUSxHQUFHO0lBQ2I7UUFDSSxFQUFFLEVBQUUsUUFBUTtRQUNaLEtBQUssRUFBRSxzQkFBc0I7UUFDN0IsT0FBTyxFQUFFLGdKQUFnSjtRQUN6SixNQUFNLEVBQUUsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxDQUFDLFVBQVUsRUFBQyxVQUFVLENBQUM7UUFDcEMsV0FBVyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsS0FBSztLQUNmO0lBQ0Q7UUFDSSxFQUFFLEVBQUUsT0FBTztRQUNYLEtBQUssRUFBRSxtQkFBbUI7UUFDMUIsT0FBTyxFQUFFLDZIQUE2SDtRQUN0SSxNQUFNLEVBQUUsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDO1FBQ2xDLFdBQVcsRUFBRSxDQUFDLFNBQVMsRUFBQyxVQUFVLENBQUM7UUFDbkMsV0FBVyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSTtLQUNkO0lBQ0Q7UUFDSSxFQUFFLEVBQUUsUUFBUTtRQUNaLEtBQUssRUFBRSwyQkFBMkI7UUFDbEMsT0FBTyxFQUFFLDJJQUEySTtRQUNwSixNQUFNLEVBQUUsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxDQUFDLFVBQVUsRUFBQyxVQUFVLENBQUM7UUFDcEMsV0FBVyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSTtLQUNkO0lBQ0Q7UUFDSSxFQUFFLEVBQUUsUUFBUTtRQUNaLEtBQUssRUFBRSx5QkFBeUI7UUFDaEMsT0FBTyxFQUFFLDBGQUEwRjtRQUNuRyxNQUFNLEVBQUUsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxDQUFDLFVBQVUsRUFBQyxTQUFTLENBQUM7UUFDbkMsV0FBVyxFQUFF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QU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFBO1FBRTdDLGFBQWEsQ0FBQyxNQUFNLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUN6RCxPQUFPLG9CQUFvQixXQUFXLFFBQVEsUUFBUSxFQUFFLENBQUE7UUFDNUQsQ0FBQyxDQUFDLENBQUE7UUFFRixJQUFJLFdBQVcsSUFBSSxJQUFJLEVBQUU7WUFDckIsYUFBYSxDQUFDLFVBQVUsR0FBRyxXQUFXLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQTtZQUM1RCxPQUFPLGFBQWEsQ0FBQyxLQUFLLENBQUE7U0FDN0I7UUFFRCxPQUFPLGFBQWEsQ0FBQTtJQUN4QixDQUFDO0lBRUQsYUFBYTtRQUNULE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFBO1FBRXpELElBQUksSUFBSSxJQUFJLElBQUksRUFBRTtZQUNkLE9BQU8sSUFBSSxDQUFBO1NBQ2Q7UUFFRCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDM0IsQ0FBQztJQUVELGNBQWMsQ0FBQyxRQUFRO1FBQ25CLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUE7SUFDMUUsQ0FBQztJQUVELGFBQWEsQ0FBQyxRQUFRO1FBQ2xCLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDN0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7SUFDeEMsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZGF0YWJhc2UgPSBbXG4gICAge1xuICAgICAgICBpZDogJ3ZuZDMzMScsXG4gICAgICAgIHRpdGxlOiAnUmFkaXNzb24gUm95YWwgSG90ZWwnLFxuICAgICAgICBkZXRhaWxzOiAn0J7RgtC10LvRjCDRgNCw0YHQv9C+0LvQvtC20LXQvSDQsiA0INC80LjQvdGD0YLQsNGFINGF0L7QtNGM0LHRiyDQvtGCINGB0YLQsNC90YbQuNC4INC80LXRgtGA0L4gwqvQnNCw0Y/QutC+0LLRgdC60LDRj8K7LiDQmiDRg9GB0LvRg9Cz0LDQvCDQs9C+0YHRgtC10Lkg0YTQuNGC0L3QtdGBLdGG0LXQvdGC0YAg0Lgg0YHQv9CwLdGG0LXQvdGC0YAg0YEg0YHQsNGD0L3QvtC5INC4INCz0LjQtNGA0L7QvNCw0YHRgdCw0LbQvdC+0Lkg0LLQsNC90L3QvtC5LicsXG4gICAgICAgIHBob3RvczogWyd2bmQzMzEucG5nJywgJ3ZuZDMzMS5wbmcnXSxcbiAgICAgICAgY29vcmRpbmF0ZXM6IFs1OS45MzIyOTM2LDMwLjM0NjAxMjldLFxuICAgICAgICBib29rZWREYXRlczogW10sXG4gICAgICAgIHByaWNlOiAxMjAwMFxuICAgIH0sXG4gICAge1xuICAgICAgICBpZDogJ2FiMmUyJyxcbiAgICAgICAgdGl0bGU6ICfQndC+0LzQtdGA0LAg0L3QsCDQodCw0LTQvtCy0L7QuScsXG4gICAgICAgIGRldGFpbHM6ICfQoNCw0YHQv9C+0LvQvtC20LXQvSDQsiA3INC80LjQvdGD0YLQsNGFINGF0L7QtNGM0LHRiyDQvtGCINCd0LXQstGB0LrQvtCz0L4g0L/RgNC+0YHQv9C10LrRgtCwLiDQmiDRg9GB0LvRg9Cz0LDQvCDQs9C+0YHRgtC10Lkg0LrRgNGD0LPQu9C+0YHRg9GC0L7Rh9C90LDRjyDRgdGC0L7QudC60LAg0YDQtdCz0LjRgdGC0YDQsNGG0LjQuCDQuCDQsdC10YHQv9C70LDRgtC90YvQuSBXaS1GaS4nLFxuICAgICAgICBwaG90b3M6IFsnYWIyZTIucG5nJywgJ2FiMmUyLnBuZyddLFxuICAgICAgICBjb29yZGluYXRlczogWzU5LjkzMDMyNSwzMC4zMjkxNTkyXSxcbiAgICAgICAgYm9va2VkRGF0ZXM6IFtdLFxuICAgICAgICBwcmljZTogNDUwMFxuICAgIH0sXG4gICAge1xuICAgICAgICBpZDogJ212bTMybCcsXG4gICAgICAgIHRpdGxlOiAn0JzQuNC90Lgg0J7RgtC10LvRjCDQvdCwINCd0LXQstGB0LrQvtC8IDEzNicsXG4gICAgICAgIGRldGFpbHM6ICfQnNC40L3QuC3QvtGC0LXQu9GMINGA0LDRgdC/0L7Qu9C+0LbQtdC9INCyINCh0LDQvdC60YIt0J/QtdGC0LXRgNCx0YPRgNCz0LUsINCyIDUg0LzQuNC90YPRgtCw0YUg0YXQvtC00YzQsdGLINC+0YIg0YHRgtCw0L3RhtC40Lgg0LzQtdGC0YDQviDCq9Cf0LvQvtGJ0LDQtNGMINCS0L7RgdGB0YLQsNC90LjRj8K7INC4INCc0L7RgdC60L7QstGB0LrQvtCz0L4g0LbQtdC70LXQt9C90L7QtNC+0YDQvtC20L3QvtCz0L4g0LLQvtC60LfQsNC70LAuJyxcbiAgICAgICAgcGhvdG9zOiBbJ212bTMybC5wbmcnLCAnbXZtMzJsLnBuZyddLFxuICAgICAgICBjb29yZGluYXRlczogWzU5LjkyOTk2MDMsMzAuMzY1ODkzMl0sXG4gICAgICAgIGJvb2tlZERhdGVzOiBbXSxcbiAgICAgICAgcHJpY2U6IDM4MDBcbiAgICB9LFxuICAgIHtcbiAgICAgICAgaWQ6ICdidmVwMTInLFxuICAgICAgICB0aXRsZTogJ9Ce0YLQtdC70Ywg0KPRgdCw0LTRjNCx0LAg0JTQtdGA0LbQsNCy0LjQvdCwJyxcbiAgICAgICAgZGV0YWlsczogJ9Cf0YDQtdC60YDQsNGB0L3Ri9C5INC+0YLQtdC70Ywg0L3QtdC00LDQu9C10LrQviDQvtGCINCY0YHQsNCw0LrQuNC10LLRgdC60L7Qs9C+INGB0L7QsdC+0YDQsCDRgSDQsdC10YHQv9C70LDRgtC90YvQvCBXaS1GaSDQvdCwINCy0YHQtdC5INGC0LXRgNGA0LjRgtC+0YDQuNC4LicsXG4gICAgICAgIHBob3RvczogWydidmVwMTIucG5nJywgJ2J2ZXAxMi5wbmcnXSxcbiAgICAgICAgY29vcmRpbmF0ZXM6IFs1OS45MTk0OTY2LDMwLjMwOTM4OV0sXG4gICAgICAgIGJvb2tlZERhdGVzOiBbXSxcbiAgICAgICAgcHJpY2U6IDg3MDBcbiAgICB9XG5dXG5cbmV4cG9ydCBmdW5jdGlvbiBjbG9uZURhdGUoZGF0ZSkge1xuICAgIHJldHVybiBuZXcgRGF0ZShkYXRlLmdldFRpbWUoKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZERheXMoZGF0ZSwgZGF5cykge1xuICAgIGRhdGUuc2V0RGF0ZShkYXRlLmdldERhdGUoKSArIGRheXMpXG4gICAgcmV0dXJuIGRhdGVcbn1cblxuZXhwb3J0IGNvbnN0IGJhY2tlbmRQb3J0ID0gMzA0MFxuZXhwb3J0IGNvbnN0IGxvY2FsU3RvcmFnZUtleSA9ICdmbGF0LXJlbnQtZGInXG5cbmV4cG9ydCBjbGFzcyBGbGF0UmVudFNkayB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIGlmICh0aGlzLl9yZWFkRGF0YWJhc2UoKSA9PSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLl93cml0ZURhdGFiYXNlKGRhdGFiYXNlKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5kYXRhYmFzZSA9IHRoaXMuX3JlYWREYXRhYmFzZSgpXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGZsYXQgYnkgSUQuXG4gICAgICogXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGlkIEZsYXQgSUQuXG4gICAgICogQHJldHVybnMge1Byb21pc2U8T2JqZWN0fG51bGw+fSBGbGF0LlxuICAgICAqL1xuICAgIGdldChpZCkge1xuICAgICAgICBjb25zdCBmbGF0ID0gdGhpcy5kYXRhYmFzZS5maW5kKChpdGVtKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gaXRlbS5pZCA9PT0gaWRcbiAgICAgICAgfSlcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZsYXQgPT0gbnVsbCA/IGZsYXQgOiB0aGlzLl9mb3JtYXRGbGF0T2JqZWN0KGZsYXQpKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNlYXJjaCBmb3IgZmxhdHMuXG4gICAgICogXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtZXRlcnMgU2VhcmNoIHBhcmFtZXRlcnNcbiAgICAgKiBAcGFyYW0ge3N0cmluZ31wYXJhbWV0ZXJzLmNpdHkgQ2l0eSBuYW1lXG4gICAgICogQHBhcmFtIHtEYXRlfSBwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlIENoZWNrLWluIGRhdGVcbiAgICAgKiBAcGFyYW0ge0RhdGV9IHBhcmFtZXRlcnMuY2hlY2tPdXREYXRlIENoZWNrLW91dCBkYXRlXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IFtwYXJhbWV0ZXJzLnByaWNlTGltaXRdIE1heCBwcmljZSBmb3IgYSBuaWdodFxuICAgICAqIEByZXR1cm5zIHtPYmplY3RbXX0gTGlzdCBvZiBzdWl0YWJsZSBmbGF0cy5cbiAgICAgKi9cbiAgICBzZWFyY2gocGFyYW1ldGVycykge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBpZiAocGFyYW1ldGVycy5jaXR5ICE9ICfQodCw0L3QutGCLdCf0LXRgtC10YDQsdGD0YDQsycpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQYXNzZWQgdW5zdXBwb3J0ZWQgY2l0eSAtIFwiJHtwYXJhbWV0ZXJzLmNpdHl9XCIuYClcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoIShwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlIGluc3RhbmNlb2YgRGF0ZSkgfHwgIShwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZSBpbnN0YW5jZW9mIERhdGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFzc2VkIGludmFsaWQgY2hlY2staW4gb3IgY2hlY2stb3V0IGRhdGUgLSBmcm9tIFwiJHtwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlfVwiIHRvIFwiJHtwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZX1cIi5gKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLl9hc3NlcnREYXRlc0FyZUNvcnJlY3QocGFyYW1ldGVycy5jaGVja0luRGF0ZSwgcGFyYW1ldGVycy5jaGVja091dERhdGUpXG5cbiAgICAgICAgICAgICAgICBpZiAocGFyYW1ldGVycy5wcmljZUxpbWl0ICE9IG51bGwgJiYgKGlzTmFOKHBhcmFtZXRlcnMucHJpY2VMaW1pdCkgfHwgIWlzRmluaXRlKHBhcmFtZXRlcnMucHJpY2VMaW1pdCkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFzc2VkIGludmFsaWQgcHJpY2UgbGltaXQgLSBcIiR7cGFyYW1ldGVycy5wcmljZUxpbWl0fVwiLmApXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgZmxhdHMgPSB0aGlzLmRhdGFiYXNlXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChwYXJhbWV0ZXJzLnByaWNlTGltaXQgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBmbGF0cyA9IGZsYXRzLmZpbHRlcigoZmxhdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZsYXQucHJpY2UgPD0gcGFyYW1ldGVycy5wcmljZUxpbWl0XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRlUmFuZ2UgPSB0aGlzLl9nZW5lcmF0ZURhdGVSYW5nZShwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlLCBwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZSlcbiAgICAgICAgICAgICAgICBmbGF0cyA9IGZsYXRzLmZpbHRlcigoZmxhdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fYXJlQWxsRGF0ZXNBdmFpbGFibGUoZmxhdCwgZGF0ZVJhbmdlKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGZsYXRzID0gZmxhdHMubWFwKChmbGF0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2Zvcm1hdEZsYXRPYmplY3QoZmxhdCwgZGF0ZVJhbmdlLmxlbmd0aCAtIDEpXG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgIHJlc29sdmUoZmxhdHMpXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcilcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCb29rIGZsYXQuXG4gICAgICogXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IGZsYXRJZCBcbiAgICAgKiBAcGFyYW0ge0RhdGV9IGNoZWNrSW5EYXRlIFxuICAgICAqIEBwYXJhbSB7RGF0ZX0gY2hlY2tPdXREYXRlXG4gICAgICogQHJldHVybnMge251bWJlcn1cbiAgICAgKi9cbiAgICBib29rKGZsYXRJZCwgY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSkge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBmbGF0ID0gdGhpcy5kYXRhYmFzZS5maW5kKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpdGVtLmlkID09PSBmbGF0SWRcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoZmxhdCA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlcmUgaXMgbm8gZmxhdCB3aXRoIElEIFwiJyArIGZsYXRJZCArICdcIi4nKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLl9hc3NlcnREYXRlc0FyZUNvcnJlY3QoY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSlcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0ZXNUb0Jvb2sgPSB0aGlzLl9nZW5lcmF0ZURhdGVSYW5nZShjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKVxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5fYXJlQWxsRGF0ZXNBdmFpbGFibGUoZmxhdCwgZGF0ZXNUb0Jvb2spKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmxhdCAke2ZsYXQuaWR9IGlzIG5vdCBhdmFpbGFibGUgZm9yIGRhdGVzICR7ZGF0ZXNUb0Jvb2suam9pbihcIixcIil9LmApXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBjb25zdCBib29rZWREYXRlcyA9IGRhdGVzVG9Cb29rLm1hcCgoZGF0ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZS5nZXRUaW1lKClcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIGZsYXQuYm9va2VkRGF0ZXMucHVzaCguLi5ib29rZWREYXRlcylcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZGF0YWJhc2UubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGF0YWJhc2VbaV0uaWQgPT09IGZsYXQuaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YWJhc2VbaV0gPSBmbGF0XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuX3dyaXRlRGF0YWJhc2UodGhpcy5kYXRhYmFzZSlcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLl9nZW5lcmF0ZVRyYW5zYWN0aW9uSWQoKSlcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIF9hc3NlcnREYXRlc0FyZUNvcnJlY3QoY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSkge1xuICAgICAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKClcbiAgICAgICAgdGhpcy5fcmVzZXRUaW1lKHRvZGF5KVxuICAgICAgICB0aGlzLl9yZXNldFRpbWUoY2hlY2tJbkRhdGUpXG4gICAgICAgIHRoaXMuX3Jlc2V0VGltZShjaGVja091dERhdGUpXG5cbiAgICAgICAgY29uc3QgZGlmZlRvZGF5ID0gdGhpcy5fY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyh0b2RheSwgY2hlY2tJbkRhdGUpXG4gICAgICAgIGlmIChkaWZmVG9kYXkgPCAwKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NoZWNrLWluIGRhdGUgY2FuXFwndCBiZSBpbiB0aGUgcGFzdC4nKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGlmZkNoZWNrID0gdGhpcy5fY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyhjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKVxuICAgICAgICBpZiAoZGlmZkNoZWNrIDwgMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDaGVjay1vdXQgZGF0ZSBtdXN0IGJlIGdyYXRlciB0aGVuIGNoZWNrLWluIGRhdGUuJylcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9yZXNldFRpbWUoZGF0ZSkge1xuICAgICAgICBkYXRlLnNldEhvdXJzKDApXG4gICAgICAgIGRhdGUuc2V0TWludXRlcygwKVxuICAgICAgICBkYXRlLnNldFNlY29uZHMoMClcbiAgICAgICAgZGF0ZS5zZXRNaWxsaXNlY29uZHMoMClcbiAgICB9XG5cbiAgICBfY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyhzdGFydERhdGUsIGVuZERhdGUpIHtcbiAgICAgICAgY29uc3QgZGlmZmVyZW5jZSA9IGVuZERhdGUuZ2V0VGltZSgpIC0gc3RhcnREYXRlLmdldFRpbWUoKVxuXG4gICAgICAgIHJldHVybiBNYXRoLmZsb29yKGRpZmZlcmVuY2UgLyAoMTAwMCAqIDYwICogNjAgKiAyNCkpXG4gICAgfVxuXG4gICAgX2dlbmVyYXRlRGF0ZVJhbmdlKGZyb20sIHRvKSB7XG4gICAgICAgIGNvbnN0IGRhdGVzID0gW11cbiAgICAgICAgY29uc3QgZGlmZmVyZW5jZUluRGF5cyA9IHRoaXMuX2NhbGN1bGF0ZURpZmZlcmVuY2VJbkRheXMoZnJvbSwgdG8pXG4gICAgICAgIFxuICAgICAgICBkYXRlcy5wdXNoKG5ldyBEYXRlKGZyb20uZ2V0RnVsbFllYXIoKSwgZnJvbS5nZXRNb250aCgpLCBmcm9tLmdldERhdGUoKSkpXG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IGRpZmZlcmVuY2VJbkRheXM7IGkrKykge1xuICAgICAgICAgIGRhdGVzLnB1c2gobmV3IERhdGUoZnJvbS5nZXRGdWxsWWVhcigpLCBmcm9tLmdldE1vbnRoKCksIGZyb20uZ2V0RGF0ZSgpICsgaSkpXG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgcmV0dXJuIGRhdGVzXG4gICAgfVxuXG4gICAgX2dlbmVyYXRlVHJhbnNhY3Rpb25JZCA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgbWluID0gMTAwMFxuICAgICAgICBjb25zdCBtYXggPSA5OTk5XG4gICAgICAgIGNvbnN0IG51bSA9IE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluKSArIG1pblxuICAgIFxuICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihudW0pXG4gICAgfVxuXG4gICAgX2FyZUFsbERhdGVzQXZhaWxhYmxlKGZsYXQsIGRhdGVSYW5nZSkge1xuICAgICAgICByZXR1cm4gZGF0ZVJhbmdlLmV2ZXJ5KChkYXRlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gIWZsYXQuYm9va2VkRGF0ZXMuaW5jbHVkZXMoZGF0ZS5nZXRUaW1lKCkpXG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgX2Zvcm1hdEZsYXRPYmplY3QoZmxhdCwgbmlnaHROdW1iZXIpIHtcbiAgICAgICAgY29uc3QgZm9ybWF0dGVkRmxhdCA9IE9iamVjdC5hc3NpZ24oe30sIGZsYXQpXG5cbiAgICAgICAgZm9ybWF0dGVkRmxhdC5waG90b3MgPSBmb3JtYXR0ZWRGbGF0LnBob3Rvcy5tYXAoKHBob3RvVXJsKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtiYWNrZW5kUG9ydH0vaW1nLyR7cGhvdG9Vcmx9YFxuICAgICAgICB9KVxuXG4gICAgICAgIGlmIChuaWdodE51bWJlciAhPSBudWxsKSB7XG4gICAgICAgICAgICBmb3JtYXR0ZWRGbGF0LnRvdGFsUHJpY2UgPSBuaWdodE51bWJlciAqIGZvcm1hdHRlZEZsYXQucHJpY2VcbiAgICAgICAgICAgIGRlbGV0ZSBmb3JtYXR0ZWRGbGF0LnByaWNlXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZm9ybWF0dGVkRmxhdFxuICAgIH1cblxuICAgIF9yZWFkRGF0YWJhc2UoKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSB3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW0obG9jYWxTdG9yYWdlS2V5KVxuXG4gICAgICAgIGlmIChkYXRhID09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiBkYXRhXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhKVxuICAgIH1cblxuICAgIF93cml0ZURhdGFiYXNlKGRhdGFiYXNlKSB7XG4gICAgICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShsb2NhbFN0b3JhZ2VLZXksIEpTT04uc3RyaW5naWZ5KGRhdGFiYXNlKSlcbiAgICB9XG5cbiAgICBfc3luY0RhdGFiYXNlKGRhdGFiYXNlKSB7XG4gICAgICAgIHRoaXMuX3dyaXRlRGF0YWJhc2UoZGF0YWJhc2UpXG4gICAgICAgIHRoaXMuZGF0YWJhc2UgPSB0aGlzLl9yZWFkRGF0YWJhc2UoKVxuICAgIH1cbn1cbiJdfQ==
